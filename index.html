<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kripto Mesaj KasasÄ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { background: #0f172a; color: white; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="min-h-screen p-4 md:p-10 flex flex-col items-center">

    <div class="w-full max-w-xl space-y-8">
        <header class="text-center">
            <h1 class="text-4xl font-extrabold text-blue-500 tracking-tight">VAULT-X</h1>
            <p class="text-slate-400 mt-2">Bulut tabanlÄ±, uÃ§tan uca ÅŸifreli mesaj saklayÄ±cÄ±.</p>
        </header>

        <section class="glass p-6 rounded-3xl shadow-2xl space-y-4">
            <h2 class="text-xl font-bold text-emerald-400">ðŸ”’ MesajÄ± Kilitle</h2>
            <textarea id="msgInput" placeholder="Gizli mesajÄ±n..." class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 focus:ring-2 focus:ring-emerald-500 outline-none h-32 transition-all"></textarea>
            
            <div class="flex flex-col gap-2 text-sm">
                <label class="text-slate-400 italic">GÃ¶rsel veya Ses KaydÄ± (Opsiyonel):</label>
                <input type="file" id="fileInput" class="text-slate-400 file:bg-blue-600 file:text-white file:border-0 file:rounded-lg file:px-4 file:py-1 hover:file:bg-blue-700 cursor-pointer">
            </div>

            <input type="password" id="savePassword" placeholder="AÃ§Ä±lÄ±ÅŸ ÅŸifresi belirle" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 focus:ring-2 focus:ring-emerald-500 outline-none">
            
            <button onclick="saveToCloud()" id="btnSave" class="w-full bg-emerald-600 hover:bg-emerald-500 py-3 rounded-xl font-bold transition-all transform active:scale-95">Åžifrele ve Buluta GÃ¶nder</button>
        </section>

        <section class="glass p-6 rounded-3xl shadow-2xl space-y-4 border-t-4 border-blue-500">
            <h2 class="text-xl font-bold text-blue-400">ðŸ”‘ MesajÄ± Ã‡Ã¶z</h2>
            <div class="flex gap-2">
                <input type="password" id="readPassword" placeholder="Åžifreyi gir" class="flex-1 bg-slate-900 border border-slate-700 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 outline-none">
                <button onclick="loadFromCloud()" id="btnLoad" class="bg-blue-600 hover:bg-blue-500 px-8 rounded-xl font-bold transition-all">Getir</button>
            </div>

            <div id="outputArea" class="mt-6 p-4 bg-slate-950 rounded-2xl hidden border border-slate-800">
                <p id="displayText" class="whitespace-pre-wrap text-slate-200 leading-relaxed"></p>
                <div id="displayMedia" class="mt-4"></div>
            </div>
        </section>
    </div>

    <script>
        // Åžifreden benzersiz ID tÃ¼retir (SHA-256)
        function generateId(password) {
            return CryptoJS.SHA256(password).toString().substring(0, 16);
        }

        async function saveToCloud() {
            const text = document.getElementById('msgInput').value;
            const password = document.getElementById('savePassword').value;
            const fileInput = document.getElementById('fileInput');
            const btn = document.getElementById('btnSave');

            if (!text && !fileInput.files[0]) return alert("BoÅŸ mesaj gÃ¶nderilemez!");
            if (!password) return alert("LÃ¼tfen bir ÅŸifre girin!");

            btn.disabled = true;
            btn.innerText = "Åžifreleniyor...";

            let fileData = "";
            let fileType = "";

            if (fileInput.files[0]) {
                const reader = new FileReader();
                fileData = await new Promise(r => {
                    reader.onload = () => r(reader.result);
                    reader.readAsDataURL(fileInput.files[0]);
                });
                fileType = fileInput.files[0].type;
            }

            // 1. Veri YapÄ±sÄ±
            const payload = JSON.stringify({ text, fileData, fileType });
            
            // 2. AES-256 Åžifreleme
            const encrypted = CryptoJS.AES.encrypt(payload, password).toString();
            const msgId = generateId(password);

            try {
                // 3. API'ye GÃ¶nder
                const res = await fetch('/api/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: msgId, data: encrypted })
                });

                if (res.ok) {
                    alert("BaÅŸarÄ±lÄ±! MesajÄ±nÄ±z gÃ¼venli bir ÅŸekilde saklandÄ±.");
                    document.getElementById('msgInput').value = "";
                    document.getElementById('savePassword').value = "";
                }
            } catch (e) {
                alert("BaÄŸlantÄ± hatasÄ±!");
            } finally {
                btn.disabled = false;
                btn.innerText = "Åžifrele ve Buluta GÃ¶nder";
            }
        }

        async function loadFromCloud() {
            const password = document.getElementById('readPassword').value;
            const output = document.getElementById('outputArea');
            const btn = document.getElementById('btnLoad');

            if (!password) return;
            btn.innerText = "...";

            const msgId = generateId(password);

            try {
                const res = await fetch(`/api/message?id=${msgId}`);
                const result = await res.json();

                if (!result.data) {
                    alert("Bu ÅŸifre ile eÅŸleÅŸen bir veri bulunamadÄ±.");
                    return;
                }

                // AES Ã‡Ã¶zme
                const bytes = CryptoJS.AES.decrypt(result.data, password);
                const decryptedStr = bytes.toString(CryptoJS.enc.Utf8);

                if (!decryptedStr) throw new Error("HatalÄ± Åžifre");

                const decrypted = JSON.parse(decryptedStr);

                // Ekrana YazdÄ±r
                output.classList.remove('hidden');
                document.getElementById('displayText').innerText = decrypted.text;
                
                const mediaDiv = document.getElementById('displayMedia');
                mediaDiv.innerHTML = "";

                if (decrypted.fileData) {
                    if (decrypted.fileType.startsWith('image/')) {
                        mediaDiv.innerHTML = `<img src="${decrypted.fileData}" class="rounded-xl w-full border border-slate-700 shadow-lg">`;
                    } else if (decrypted.fileType.startsWith('audio/')) {
                        mediaDiv.innerHTML = `<audio controls src="${decrypted.fileData}" class="w-full"></audio>`;
                    } else {
                        mediaDiv.innerHTML = `<a href="${decrypted.fileData}" download="dosya" class="text-blue-400 underline">DosyayÄ± Ä°ndir</a>`;
                    }
                }
            } catch (e) {
                alert("HatalÄ± ÅŸifre veya bozuk veri!");
                output.classList.add('hidden');
            } finally {
                btn.innerText = "Getir";
            }
        }
    </script>
</body>
</html>
