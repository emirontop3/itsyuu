<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Crypt - Gizli Mesaj</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { background: #020617; color: #e2e8f0; font-family: sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .loader { border-top-color: #3b82f6; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6">

    <div class="w-full max-w-lg space-y-6">
        <div class="text-center">
            <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">CRYPT CLOUD</h1>
            <p class="text-slate-400 text-sm mt-2">Mesajlar sunucuya gitmeden cihazÄ±nda ÅŸifrelenir.</p>
        </div>

        <div class="glass p-6 rounded-3xl shadow-2xl">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-emerald-400">
                <span>ðŸ”’</span> Mesaj Kilitle
            </h2>
            <div class="space-y-4">
                <textarea id="msgInput" rows="3" placeholder="Gizli notun..." class="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-3 focus:ring-2 focus:ring-emerald-500 outline-none transition"></textarea>
                
                <input type="file" id="fileInput" class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-slate-800 file:text-slate-300">

                <input type="password" id="savePassword" placeholder="Bu mesaj iÃ§in anahtar ÅŸifre" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-3 focus:ring-2 focus:ring-emerald-500 outline-none">
                
                <button onclick="saveToCloud()" id="btnSave" class="w-full bg-emerald-600 hover:bg-emerald-500 py-3 rounded-xl font-bold transition duration-300">Buluta GÃ¶nder</button>
            </div>
        </div>

        <div class="glass p-6 rounded-3xl shadow-2xl">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-blue-400">
                <span>ðŸ”‘</span> Mesaj AÃ§
            </h2>
            <div class="flex gap-2">
                <input type="password" id="readPassword" placeholder="Anahtar ÅŸifreyi girin" class="flex-1 bg-slate-900/50 border border-slate-700 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 outline-none">
                <button onclick="loadFromCloud()" id="btnLoad" class="bg-blue-600 hover:bg-blue-500 px-6 rounded-xl font-bold transition">AÃ§</button>
            </div>

            <div id="outputArea" class="mt-6 p-4 bg-slate-950/50 rounded-xl hidden border border-blue-500/50">
                <p id="displayText" class="text-white mb-4"></p>
                <div id="displayMedia"></div>
            </div>
        </div>
    </div>

    <script>
        // SHA-256 ile ÅŸifreden benzersiz bir ID Ã¼retme (VeritabanÄ± anahtarÄ± iÃ§in)
        function getMsgId(password) {
            return CryptoJS.SHA256(password).toString().substring(0, 16);
        }

        async function saveToCloud() {
            const text = document.getElementById('msgInput').value;
            const password = document.getElementById('savePassword').value;
            const fileInput = document.getElementById('fileInput');
            const btn = document.getElementById('btnSave');

            if (!password) return alert("Åžifre belirlemelisin!");
            
            btn.innerText = "Åžifreleniyor...";
            btn.disabled = true;

            let fileData = null;
            let fileType = null;

            if (fileInput.files[0]) {
                const reader = new FileReader();
                fileData = await new Promise(r => {
                    reader.onload = () => r(reader.result);
                    reader.readAsDataURL(fileInput.files[0]);
                });
                fileType = fileInput.files[0].type;
            }

            const payload = JSON.stringify({ text, fileData, fileType });
            const encryptedData = CryptoJS.AES.encrypt(payload, password).toString();
            const msgId = getMsgId(password);

            try {
                const res = await fetch('/api/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: msgId, data: encryptedData })
                });
                
                if (res.ok) alert("Mesaj baÅŸarÄ±yla buluta yÃ¼klendi!");
            } catch (err) {
                alert("Hata oluÅŸtu!");
            } finally {
                btn.innerText = "Buluta GÃ¶nder";
                btn.disabled = false;
            }
        }

        async function loadFromCloud() {
            const password = document.getElementById('readPassword').value;
            const output = document.getElementById('outputArea');
            const btn = document.getElementById('btnLoad');

            if (!password) return;
            btn.innerText = "...";

            const msgId = getMsgId(password);

            try {
                const res = await fetch(`/api/message?id=${msgId}`);
                const result = await res.json();

                if (!result.data) {
                    alert("Bu ÅŸifreye ait bir mesaj bulunamadÄ±.");
                    return;
                }

                const bytes = CryptoJS.AES.decrypt(result.data, password);
                const decrypted = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));

                output.classList.remove('hidden');
                document.getElementById('displayText').innerText = decrypted.text;
                
                const mediaDiv = document.getElementById('displayMedia');
                mediaDiv.innerHTML = "";

                if (decrypted.fileData) {
                    if (decrypted.fileType.startsWith('image/')) {
                        mediaDiv.innerHTML = `<img src="${decrypted.fileData}" class="rounded-lg w-full">`;
                    } else if (decrypted.fileType.startsWith('audio/')) {
                        mediaDiv.innerHTML = `<audio controls src="${decrypted.fileData}" class="w-full"></audio>`;
                    } else {
                        mediaDiv.innerHTML = `<a href="${decrypted.fileData}" download="dosya" class="text-blue-400 underline italic text-sm">DosyayÄ± Ä°ndir</a>`;
                    }
                }
            } catch (e) {
                alert("Åžifre yanlÄ±ÅŸ veya veri bozuk!");
            } finally {
                btn.innerText = "AÃ§";
            }
        }
    </script>
</body>
</html>
